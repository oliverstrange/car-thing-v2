import { VerticalBox } from "std-widgets.slint";
import { MainMenu } from "./screens/main_menu.slint";
import { OilTemperature } from "./screens/oil_temperature.slint";
import { OilPressure } from "./screens/oil_pressure.slint";
import { LapTimer } from "./screens/lap_timer.slint";
import { Settings } from "./screens/settings.slint";

export component App inherits Window {
    title: "Circular Display App";
    width: 240px;
    height: 240px;
    background: dark_mode ? #111111 : #ffffff;
    property <bool> dark_mode: false;   // Dark mode enabled by default
    property <color> accent_color: #26ccfa; // Accent color blue by default
    property <int> selected_index: 0;   // Current menu item
    property <int> visible_screen_index: 0;   // Current visible screen
    property <int> oil_temperature: 60;
    property <int> oil_pressure: 50;
    callback move_up();
    callback move_down();
    callback enter();
    callback set_property(name: string, value: int);
    move_up() => {
        if (visible_screen_index == 0) {
            // Menu screen
            main_menu.move_up();
        } else if (visible_screen_index == 3) {
            // Lap timer screen
            lap_timer.start_stop();
        } else if (visible_screen_index == 4) {
            // Settings screen
            settings.move_up();
        }
    }
    move_down() => {
        if (visible_screen_index == 0) {
            // Menu screen
            main_menu.move_down();
        } else if (visible_screen_index == 3) {
            // Lap timer screen
            lap_timer.reset();
        } else if (visible_screen_index == 4) {
            // Settings screen
            settings.move_down();
        }
    }
    enter() => {
        if (visible_screen_index == 0) {
            // Menu screen
            main_menu.enter();
        } else if (visible_screen_index == 4) {
            // Settings screen
            settings.enter();
        } else if (visible_screen_index == 1 || visible_screen_index == 2 || visible_screen_index == 3) {
            // Oil Temperature, Oil Pressure, or Lap Timer screens - return to menu
            visible_screen_index = 0;
        }
    }
    set_property(name, value) => {
        if (name == "oil_temperature") {
            oil_temperature = value;
        } else if (name == "oil_pressure") {
            oil_pressure = value;
        }
    }   

    // -----------------------------
    // Keyboard handler
    // -----------------------------
    my-key-handler := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.UpArrow) {
                debug("Up pressed");
                move_up();
            }
            ;
            if (event.text == Key.DownArrow) {
                debug("Down pressed");
                move_down();
            }
            ;
            if (event.text == Key.Return) {
                debug("Enter pressed");
                enter();
            }
            ;
            accept
        }
    }

    main_menu := MainMenu {
        selected_index: selected_index;
        visible: visible_screen_index == 0;
        dark_mode: dark_mode;
        item_selected(screen_index) => {
            visible_screen_index = screen_index;
        }
    }

    OilTemperature {
        visible: visible_screen_index == 1;
        temperature: oil_temperature;
        dark_mode: dark_mode;
    }

    OilPressure {
        visible: visible_screen_index == 2;
        pressure: oil_pressure;
        dark_mode: dark_mode;
    }

    lap_timer := LapTimer {
        visible: visible_screen_index == 3;
        dark_mode: dark_mode;
        accent_color: accent_color;
    }

    settings := Settings {
        visible: visible_screen_index == 4;
        dark_mode: dark_mode;
        return_to_menu() => {
            visible_screen_index = 0;
        }
        toggle_dark_mode() => {
            dark_mode = !dark_mode;
        }
        change_accent_color(new_color) => {
            accent_color = new_color;
        }
    }
}
